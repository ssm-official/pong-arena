<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoPong — Admin Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { arena: { bg: '#0a0a1a', card: '#111128', accent: '#7c3aed' } } } }
    };
  </script>
  <style>
    body { background: #0a0a1a; font-family: 'Segoe UI', system-ui, sans-serif; }
    .glow-border { box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); }
  </style>
</head>
<body class="text-gray-100 min-h-screen">
  <nav class="bg-arena-card border-b border-purple-900/30 px-6 py-3 flex items-center justify-between">
    <span class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
      CRYPTOPONG — ADMIN
    </span>
    <a href="/" class="text-sm text-gray-400 hover:text-purple-400">&larr; Back to CryptoPong</a>
  </nav>

  <div class="max-w-4xl mx-auto px-4 py-6">

    <!-- LOGIN -->
    <div id="login-view" class="max-w-sm mx-auto py-20">
      <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
      <div class="bg-arena-card rounded-xl p-6 glow-border">
        <input id="admin-pw" type="password" placeholder="Admin password"
          class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white mb-3 focus:border-purple-500 focus:outline-none" />
        <button onclick="adminLogin()" class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded-lg font-medium transition">
          Login
        </button>
        <p id="login-error" class="text-red-400 text-sm mt-2 hidden"></p>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-view" class="hidden">

      <!-- SVG TEMPLATE DOWNLOAD -->
      <div class="bg-arena-card rounded-xl p-6 glow-border mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold text-purple-400">Skin Template</h3>
            <p class="text-gray-500 text-xs mt-1">SVG template at correct scale: 120x400px canvas, rounded paddle body centered. Design for LEFT paddle — game auto-mirrors for right side.</p>
          </div>
          <div class="flex gap-2">
            <button onclick="downloadTemplate()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition">
              Download Template SVG
            </button>
            <button onclick="previewTemplate()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-medium transition">
              Preview
            </button>
          </div>
        </div>
        <div id="template-preview" class="hidden mt-4 flex items-center gap-6">
          <div class="bg-gray-900 rounded-lg p-4 border border-gray-700" id="template-preview-container"></div>
          <div class="text-xs text-gray-500 space-y-1">
            <p><span class="text-purple-400">Purple outline</span> = paddle hitbox (14x110, game scale)</p>
            <p><span class="text-gray-400">Gray rect</span> = paddle body zone (~28x220)</p>
            <p>Full canvas = 120x400 (decoration zone)</p>
            <p>Rendered in-game at 60x200px</p>
          </div>
        </div>
      </div>

      <!-- CREATE CRATE -->
      <div class="bg-arena-card rounded-xl p-6 glow-border mb-6">
        <h3 class="text-lg font-bold mb-3 text-purple-400">Create Crate</h3>
        <div class="grid grid-cols-2 gap-3">
          <input id="crate-name" type="text" placeholder="Crate name" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          <input id="crate-price" type="number" placeholder="Price (PONG)" value="10000" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          <input id="crate-desc" type="text" placeholder="Description" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          <input id="crate-color" type="text" placeholder="Glow color (#hex)" value="#7c3aed" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
        </div>
        <label class="flex items-center gap-2 mt-3 text-sm text-gray-300 cursor-pointer">
          <input id="crate-limited" type="checkbox" class="rounded" /> Limited edition
        </label>
        <button onclick="createCrate()" class="mt-3 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition">
          Create Crate
        </button>
      </div>

      <!-- UPLOAD SKIN -->
      <div class="bg-arena-card rounded-xl p-6 glow-border mb-6">
        <h3 class="text-lg font-bold mb-3 text-purple-400">Upload Skin</h3>
        <div class="grid grid-cols-2 gap-3">
          <select id="skin-crate" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none">
            <option value="">Select crate...</option>
          </select>
          <input id="skin-name" type="text" placeholder="Skin name" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          <input id="skin-desc" type="text" placeholder="Description" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          <select id="skin-rarity" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none">
            <option value="common">Common</option>
            <option value="rare">Rare</option>
            <option value="legendary">Legendary</option>
          </select>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Type</label>
            <select id="skin-type" onchange="toggleSkinInputs()" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none">
              <option value="image">Image (SVG/PNG)</option>
              <option value="color">Color</option>
            </select>
          </div>
          <div id="skin-color-input">
            <label class="block text-sm text-gray-400 mb-1">CSS Color (for color type)</label>
            <input id="skin-css" type="text" placeholder="#ff0000" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
          </div>
        </div>
        <div id="skin-file-input" class="mt-3">
          <label class="block text-sm text-gray-400 mb-1">SVG or PNG file (120x400, transparent bg)</label>
          <input id="skin-file" type="file" accept=".svg,.png" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" />
        </div>
        <button onclick="uploadSkin()" class="mt-3 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition">
          Upload Skin
        </button>
      </div>

      <!-- CRATE LIST -->
      <div id="crate-list" class="space-y-4"></div>
    </div>
  </div>

  <!-- EDIT SKIN MODAL -->
  <div id="edit-skin-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
    <div class="bg-arena-card rounded-xl p-6 max-w-md w-full mx-4 glow-border">
      <h3 class="text-lg font-bold text-purple-400 mb-3">Edit Skin</h3>
      <input type="hidden" id="edit-skin-id" />
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Name</label>
          <input id="edit-skin-name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Description</label>
          <input id="edit-skin-desc" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Rarity</label>
            <select id="edit-skin-rarity" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none">
              <option value="common">Common</option>
              <option value="rare">Rare</option>
              <option value="legendary">Legendary</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Type</label>
            <select id="edit-skin-type" onchange="toggleEditSkinInputs()" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none">
              <option value="image">Image (SVG/PNG)</option>
              <option value="color">Color</option>
            </select>
          </div>
        </div>
        <div id="edit-skin-color-row">
          <label class="block text-sm text-gray-400 mb-1">CSS Color</label>
          <input id="edit-skin-css" type="text" placeholder="#ff0000" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-purple-500 focus:outline-none" />
        </div>
        <div id="edit-skin-file-row">
          <label class="block text-sm text-gray-400 mb-1">Replace image (SVG/PNG) — leave empty to keep current</label>
          <input id="edit-skin-file" type="file" accept=".svg,.png" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" />
          <div id="edit-skin-current-img" class="mt-2 text-xs text-gray-500"></div>
        </div>
      </div>
      <div class="flex gap-2 mt-4">
        <button onclick="saveEditSkin()" class="flex-1 bg-purple-600 hover:bg-purple-700 py-2 rounded-lg font-medium transition">Save</button>
        <button onclick="closeEditSkin()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let adminPw = sessionStorage.getItem('adminPw') || '';

    if (adminPw) { verifyLogin(adminPw); }

    function headers() {
      return { 'Content-Type': 'application/json', 'x-admin-password': adminPw };
    }

    async function adminLogin() {
      const pw = document.getElementById('admin-pw').value;
      await verifyLogin(pw);
    }

    async function verifyLogin(pw) {
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pw })
        }).then(r => r.json());

        if (res.error) {
          const errEl = document.getElementById('login-error');
          if (errEl) { errEl.textContent = res.error; errEl.classList.remove('hidden'); }
          return;
        }

        adminPw = pw;
        sessionStorage.setItem('adminPw', pw);
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('admin-view').classList.remove('hidden');
        loadCrates();
      } catch (err) {
        console.error(err);
      }
    }

    // ============================
    // SVG TEMPLATE
    // ============================
    function getSkinTemplateSVG() {
      return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 400" width="120" height="400">
  <!--
    PONG ARENA SKIN TEMPLATE
    Canvas: 120x400px
    Rendered in-game at: 60x200px
    Paddle hitbox: 26x110 (centered)
    Design for LEFT-side paddle; game auto-mirrors for right side.

    ZONES:
    - Hat/crown zone: y 0-90 (above paddle)
    - Paddle body:    y 90-310 (center 52px wide, x 34-86)
    - Trail zone:     y 310-400 (below paddle)
    - Wings/shields:  x 0-34 and x 86-120 (sides)

    DELETE THIS GUIDE LAYER WHEN DONE — keep your art only.
  -->

  <!-- GUIDE LAYER (delete before exporting) -->
  <g id="guides" opacity="0.3">
    <!-- Full canvas border -->
    <rect x="1" y="1" width="118" height="398" fill="none" stroke="#555" stroke-width="1" stroke-dasharray="4,4"/>
    <!-- Paddle body zone -->
    <rect x="34" y="90" width="52" height="220" rx="8" ry="8" fill="none" stroke="#a855f7" stroke-width="2"/>
    <!-- Center crosshair -->
    <line x1="60" y1="190" x2="60" y2="210" stroke="#a855f7" stroke-width="1"/>
    <line x1="50" y1="200" x2="70" y2="200" stroke="#a855f7" stroke-width="1"/>
    <!-- Zone labels -->
    <text x="60" y="50" text-anchor="middle" fill="#888" font-size="10" font-family="sans-serif">HAT ZONE</text>
    <text x="60" y="200" text-anchor="middle" fill="#a855f7" font-size="10" font-family="sans-serif">PADDLE</text>
    <text x="60" y="360" text-anchor="middle" fill="#888" font-size="10" font-family="sans-serif">TRAIL ZONE</text>
  </g>

  <!-- YOUR ART GOES HERE -->
  <!-- Example: a basic rounded paddle shape -->
  <rect x="34" y="90" width="52" height="220" rx="8" ry="8" fill="#a855f7"/>
</svg>`;
    }

    function downloadTemplate() {
      const svg = getSkinTemplateSVG();
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pong-arena-skin-template.svg';
      a.click();
      URL.revokeObjectURL(url);
    }

    function previewTemplate() {
      const container = document.getElementById('template-preview-container');
      const wrapper = document.getElementById('template-preview');
      if (wrapper.classList.contains('hidden')) {
        // Show at 50% scale for preview
        container.innerHTML = `<div style="width:60px;height:200px;overflow:visible">${getSkinTemplateSVG().replace('width="120"', 'width="60"').replace('height="400"', 'height="200"')}</div>`;
        wrapper.classList.remove('hidden');
      } else {
        wrapper.classList.add('hidden');
      }
    }

    // ============================
    // SKIN INPUTS TOGGLE
    // ============================
    function toggleSkinInputs() {
      const type = document.getElementById('skin-type').value;
      document.getElementById('skin-file-input').style.display = type === 'image' ? '' : 'none';
      document.getElementById('skin-color-input').style.display = type === 'color' ? '' : 'none';
    }

    // ============================
    // CRATE CRUD
    // ============================
    let allSkinsMap = {}; // skinId -> skin object for edit lookups

    async function loadCrates() {
      const res = await fetch('/api/admin/crates', { headers: { 'x-admin-password': adminPw } }).then(r => r.json());
      const crates = res.crates || [];

      // Build skin lookup map
      allSkinsMap = {};
      for (const c of crates) {
        for (const s of (c.skins || [])) {
          allSkinsMap[s.skinId] = s;
        }
      }

      const sel = document.getElementById('skin-crate');
      sel.innerHTML = '<option value="">Select crate...</option>' +
        crates.map(c => `<option value="${c.crateId}">${esc(c.name)}</option>`).join('');

      const container = document.getElementById('crate-list');
      if (crates.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No crates yet. Create one above.</p>';
        return;
      }

      container.innerHTML = crates.map(c => `
        <div class="bg-arena-card rounded-xl p-4 border-l-4" style="border-color: ${esc(c.imageColor)}">
          <div class="flex items-center justify-between mb-2">
            <div>
              <h4 class="font-bold">${esc(c.name)}</h4>
              <p class="text-gray-500 text-xs">${esc(c.description || '')} — ${c.price.toLocaleString()} $PONG — ${c.limited ? 'LIMITED' : 'Standard'} — ${c.active ? 'Active' : 'Inactive'}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="toggleCrate('${c.crateId}', ${!c.active})" class="text-xs px-3 py-1 rounded ${c.active ? 'bg-red-900 text-red-300 hover:bg-red-800' : 'bg-green-900 text-green-300 hover:bg-green-800'}">
                ${c.active ? 'Deactivate' : 'Activate'}
              </button>
              <button onclick="deleteCrate('${c.crateId}')" class="text-xs px-3 py-1 rounded bg-red-900 text-red-300 hover:bg-red-800">
                Delete
              </button>
            </div>
          </div>
          ${c.skins.length > 0 ? `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
              ${c.skins.map(s => `
                <div class="bg-gray-800 rounded-lg p-2 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    ${s.type === 'color'
                      ? `<div class="w-6 h-6 rounded" style="background:${esc(s.cssValue)}"></div>`
                      : `<img src="${esc(s.imageUrl)}" class="w-6 h-10 object-contain" />`
                    }
                    <div>
                      <span class="text-sm font-medium">${esc(s.name)}</span>
                      <span class="text-xs ml-1 ${s.rarity === 'legendary' ? 'text-yellow-400' : s.rarity === 'rare' ? 'text-purple-400' : 'text-gray-500'}">${s.rarity}</span>
                    </div>
                  </div>
                  <div class="flex gap-1">
                    <button onclick="openEditSkin('${s.skinId}')" class="text-purple-400 hover:text-purple-300 text-xs">Edit</button>
                    <button onclick="deleteSkin('${s.skinId}')" class="text-red-400 hover:text-red-300 text-xs">X</button>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : '<p class="text-gray-600 text-xs mt-1">No skins in this crate.</p>'}
        </div>
      `).join('');
    }

    async function createCrate() {
      const body = {
        name: document.getElementById('crate-name').value,
        description: document.getElementById('crate-desc').value,
        price: Number(document.getElementById('crate-price').value),
        imageColor: document.getElementById('crate-color').value,
        limited: document.getElementById('crate-limited').checked,
      };
      if (!body.name) return alert('Crate name is required');
      const res = await fetch('/api/admin/crate', {
        method: 'POST', headers: headers(), body: JSON.stringify(body)
      }).then(r => r.json());
      if (res.error) return alert(res.error);
      document.getElementById('crate-name').value = '';
      document.getElementById('crate-desc').value = '';
      loadCrates();
    }

    async function uploadSkin() {
      const crateId = document.getElementById('skin-crate').value;
      const name = document.getElementById('skin-name').value;
      const type = document.getElementById('skin-type').value;
      if (!crateId || !name) return alert('Select a crate and enter a name');

      const formData = new FormData();
      formData.append('crateId', crateId);
      formData.append('name', name);
      formData.append('description', document.getElementById('skin-desc').value);
      formData.append('rarity', document.getElementById('skin-rarity').value);
      formData.append('type', type);

      if (type === 'image') {
        const file = document.getElementById('skin-file').files[0];
        if (!file) return alert('Select an SVG or PNG file');
        const ext = file.name.match(/\.(svg|png)$/i)?.[0] || '.svg';
        formData.append('image', file);
        formData.append('fileName', name.toLowerCase().replace(/[^a-z0-9]+/g, '-') + ext);
      } else {
        const css = document.getElementById('skin-css').value;
        if (!css) return alert('Enter a CSS color value');
        formData.append('cssValue', css);
      }

      const res = await fetch('/api/admin/skin', {
        method: 'POST',
        headers: { 'x-admin-password': adminPw },
        body: formData
      }).then(r => r.json());

      if (res.error) return alert(res.error);
      document.getElementById('skin-name').value = '';
      document.getElementById('skin-desc').value = '';
      document.getElementById('skin-file').value = '';
      document.getElementById('skin-css').value = '';
      loadCrates();
    }

    async function toggleCrate(crateId, active) {
      await fetch(`/api/admin/crate/${crateId}`, {
        method: 'PUT', headers: headers(), body: JSON.stringify({ active })
      });
      loadCrates();
    }

    async function deleteCrate(crateId) {
      if (!confirm('Delete this crate and ALL its skins?')) return;
      await fetch(`/api/admin/crate/${crateId}`, {
        method: 'DELETE', headers: { 'x-admin-password': adminPw }
      });
      loadCrates();
    }

    async function deleteSkin(skinId) {
      if (!confirm('Delete this skin?')) return;
      await fetch(`/api/admin/skin/${skinId}`, {
        method: 'DELETE', headers: { 'x-admin-password': adminPw }
      });
      loadCrates();
    }

    // ============================
    // EDIT SKIN MODAL
    // ============================
    function openEditSkin(skinId) {
      const skin = allSkinsMap[skinId];
      if (!skin) return alert('Skin not found');
      document.getElementById('edit-skin-id').value = skin.skinId;
      document.getElementById('edit-skin-name').value = skin.name || '';
      document.getElementById('edit-skin-desc').value = skin.description || '';
      document.getElementById('edit-skin-rarity').value = skin.rarity || 'common';
      document.getElementById('edit-skin-type').value = skin.type || 'color';
      document.getElementById('edit-skin-css').value = skin.cssValue || '';
      document.getElementById('edit-skin-file').value = '';

      const currentImg = document.getElementById('edit-skin-current-img');
      if (skin.type === 'image' && skin.imageUrl) {
        currentImg.innerHTML = `Current: <a href="${esc(skin.imageUrl)}" target="_blank" class="text-purple-400 underline">${esc(skin.imageUrl)}</a>`;
      } else {
        currentImg.innerHTML = '';
      }

      toggleEditSkinInputs();
      document.getElementById('edit-skin-modal').classList.remove('hidden');
    }

    function closeEditSkin() {
      document.getElementById('edit-skin-modal').classList.add('hidden');
    }

    function toggleEditSkinInputs() {
      const type = document.getElementById('edit-skin-type').value;
      document.getElementById('edit-skin-file-row').style.display = type === 'image' ? '' : 'none';
      document.getElementById('edit-skin-color-row').style.display = type === 'color' ? '' : 'none';
    }

    async function saveEditSkin() {
      const skinId = document.getElementById('edit-skin-id').value;
      if (!skinId) return;

      const type = document.getElementById('edit-skin-type').value;
      const formData = new FormData();
      formData.append('name', document.getElementById('edit-skin-name').value);
      formData.append('description', document.getElementById('edit-skin-desc').value);
      formData.append('rarity', document.getElementById('edit-skin-rarity').value);
      formData.append('type', type);

      if (type === 'color') {
        formData.append('cssValue', document.getElementById('edit-skin-css').value);
      }

      if (type === 'image') {
        const file = document.getElementById('edit-skin-file').files[0];
        if (file) {
          formData.append('image', file);
          const ext = file.name.match(/\.(svg|png)$/i)?.[0] || '.png';
          formData.append('fileName', document.getElementById('edit-skin-name').value.toLowerCase().replace(/[^a-z0-9]+/g, '-') + ext);
        }
      }

      const res = await fetch(`/api/admin/skin/${skinId}`, {
        method: 'PUT',
        headers: { 'x-admin-password': adminPw },
        body: formData
      }).then(r => r.json());

      if (res.error) return alert(res.error);
      closeEditSkin();
      loadCrates();
    }

    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
